import { Tab, Tabs } from '@rspress/core/theme';

# Trace

OpenTelemetry 也被称为 OTEL，是一个供应商中立的、开源的可观测性框架， 可用于插桩、生成、采集和导出链路、 指标和日志等遥测数据。
OpenTelemetry 作为一个行业标准，得到了 40 多个可观测供应商的支持， 被许多代码库、服务和应用集成，被众多最终用户采用。

因此我们Trace标准采用 [opentelemetry](https://opentelemetry.io/docs/)

##  默认配置

<Tabs>
  <Tab label="toml">
```toml 
[trace]
  enable = false
  provider = "otlp"
  endpoint = "127.0.0.1:4318"
  insecure = true
```
</Tab>
<Tab label="env">
</Tab>
```sh 
TRACE_ENABLE=false
TRACE_PROVIDER="otlp"
OTEL_EXPORTER_OTLP_TRACES_ENDPOINT="127.0.0.1:4318"
TRACE_INSECURE = true
```
</Tabs>

## 样例演示

![iam](/img/trace/example.png)

### 环境准备

这里我们使用jaeger作为Trace Provider, 需要提前安装Jager
```sh
docker run -d --name jaeger \
  -e COLLECTOR_OTLP_ENABLED=true \
  -p 16686:16686 \
  -p 4317:4317 \
  -p 4318:4318 \
  jaegertracing/all-in-one:latest
```

+ otlp go sdk 使用方法: https://opentelemetry.io/docs/languages/go/exporters/
+ jaeger 端口说明: https://www.jaegertracing.io/docs/1.55/getting-started/#all-in-one


### 接口

社区提供了很多开箱即用的组件库: [Registry](https://opentelemetry.io/ecosystem/registry/)


### 数据库


### 客户端


## 自定义埋点

```go
_, span := tracer.Start(reg.Request.Context(), "getUser", oteltrace.WithAttributes(attribute.String("id", uid)))
defer span.End()
```

## 测试

```sh
curl -H "traceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01" http://localhost:8080/your-api
```

## 采样策略

TraceIDRatioBased(ratio float64) 确实是一个百分比采样器：参数范围：0.0 到 1.0 之间的浮点数

+ 0.0：不采样任何 trace（0%）
+ 0.5：采样 50% 的请求
+ 1.0：采样所有请求（100%）

工作原理：基于 TraceID 进行哈希计算，确保相同的 TraceID 在不同服务中会有相同的采样决策

推荐的采样策略:
```sh
前端/网关 (采样率: 10%)
    ↓
你的Go服务 (ParentBased + 根采样率: 0%)
    ↓
结果: 只有那10%被网关采样的请求会在你的服务中产生trace
```

## 生产环境注意事项

+ 监控导出器状态：添加健康检查监控导出器是否正常工作
+ 错误处理：妥善处理导出失败的情况，避免影响主业务
+ 性能调优：根据实际流量调整批量处理参数
+ 安全配置：生产环境使用 TLS 和认证
+ 避免 stdout：生产环境不要使用 stdout exporter